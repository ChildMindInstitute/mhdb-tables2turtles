#!/usr/bin/env python
"""
This program converts a mental health spreadsheet to an RDF text document.

Authors:
    - Arno Klein, 2017  (arno@childmind.org)  http://binarybottle.com
    - Jon Clucas, 2017 (jon.clucas@childmind.org)

Copyright 2017, Child Mind Institute (http://childmind.org), Apache v2.0 License

"""
import os
import argparse
import numpy as np
import pandas as pd
import re
import urllib.request

from mhdb.info import __version__ as version
from mhdb.spreadsheet_io import convert_string_to_label, create_label, \
    get_index2, get_cell, download_google_sheet
from mhdb.write_ttl import write_header, write_ttl 


def ICD_code(Disorder, ICD, id, X):
    # function to turtle ICD code and coding system
    ICD = str(ICD)
    ICD_uri_code = get_cell(
        Disorder,
        'ICD{0}code'.format(ICD),
        iD,
        X,
        True
    )
    if ICD_uri_code:
        ICD_uri = "ICD{0}:{1}".format(
            ICD,
            str(ICD_uri_code)
        )
        ICD_coding_string = (
            "{0} health-lifesci:codingSystem \"ICD{1}CM\"^^rdfs:Literal "
        ).format(
            ICD_uri,
            ICD
        )
    else:
        ICD_uri, ICD_coding_string = None, None
    return(ICD_uri, ICD_coding_string)

    
def main():
    mentalhealthFILE = download_google_sheet(
        'data/mentalhealth.xlsx',
        "13a0w3ouXq5sFCa0fBsg9xhWx67RGJJJqLjD_Oy1c3b0"
    )
    mentalhealthtechnology3FILE = download_google_sheet(
        'data/mentalhealthtechnology3.xlsx',
        "1SK-kT7EH34omb4FJnFW2uJbsXbklawlPXFx2X7hLnc8"
    )
    revised_structureFILE = download_google_sheet(
        'data/revised_structure.xlsx',
        "1REHmDXldCZ_L403Zq0N0LdhwNNEAXEIJHcNHzOIjnSQ"
    )
    
    base_uri = "http://www.purl.org/mentalhealth"
    outfile = os.path.join(os.getcwd(), 'mhdb.ttl')

    # ------------------------------------------------------------------------------
    # Import spreadsheets
    # ------------------------------------------------------------------------------
    mentalhealth_xls = pd.ExcelFile(mentalhealthFILE)
    mentalhealthtechnology3_xls = pd.ExcelFile(mentalhealthtechnology3FILE)
    revised_structure_xls = pd.ExcelFile(revised_structureFILE)
    X = ['', 'nan', np.nan, 'None', None]

    # ------------------------------------------------------------------------------
    # Create output RDF mentalhealthFILE
    # ------------------------------------------------------------------------------
    label = "mental health database"
    comment="""
    ======================
    Mental Health Database
    ======================

    This mental health database inter-relates information about mental health
    diagnoses, symptoms, assessement questionnaires, etc., and is licensed
    under the terms of the Creative Commons BY license.
    Current information can be found on the website, http://mentalhealth.tech.
    """

    # ------------------------------------------------------------------------------
    # Extract worksheets as pandas dataframes
    # ------------------------------------------------------------------------------
    #sheet_names = mentalhealth_xls.sheet_names
    #for sheet_name in sheet_names:
    #    exec("{0} = mentalhealth_xls.parse('{0}')".format(sheet_name))
    Classes = mentalhealth_xls.parse("Classes")
    Properties = mentalhealth_xls.parse("Properties")
    Level0 = mentalhealth_xls.parse("DisorderCategory")
    Level1 = mentalhealth_xls.parse("DisorderSubcategory")
    Level2 = mentalhealth_xls.parse("DisorderSubsubcategory")
    Level3 = mentalhealth_xls.parse("DisorderSubsubsubcategory")
    Disorder = mentalhealth_xls.parse("Disorder")
    Severity = mentalhealth_xls.parse("DisorderSeverity")
    Specifier = mentalhealth_xls.parse("DiagnosticSpecifier")
    Criterion = mentalhealth_xls.parse("DiagnosticCriterion")
    SignOrSymptom = mentalhealth_xls.parse("SignOrSymptom")
    SymptomCat = mentalhealth_xls.parse("SignOrSymptom_Main_Category")
    Symptom = mentalhealth_xls.parse("SignOrSymptom_Sub_Category")
    Questionnaire = mentalhealth_xls.parse("Questionnaire")
    Question = mentalhealth_xls.parse("Question")
    QuestionCat = mentalhealth_xls.parse("QuestionCategory")
    AnswerType = mentalhealth_xls.parse("AnswerType")
    Reference = mentalhealth_xls.parse("Reference")
    ReferenceType = mentalhealth_xls.parse("ReferenceType")
    CMICat = mentalhealth_xls.parse("ChildMindInstituteCategory")
    Ontologies = mentalhealth_xls.parse("Ontologies")
    TechProject = mentalhealthtechnology3_xls.parse("Project")
    RSOT = mentalhealthtechnology3_xls.parse("ResearchStudyOnTech")
    RCTDT = mentalhealthtechnology3_xls.parse("ResearchCitedToDevelopTech")
    NAAT = mentalhealthtechnology3_xls.parse("NewsArticleAboutTech")
    OSC = mentalhealthtechnology3_xls.parse("OpenSourceCode")
    TechSensor = mentalhealthtechnology3_xls.parse("Sensor")
    TechMHealthPeople = mentalhealthtechnology3_xls.parse("MHealthPeople")
    TechHomepageLink = mentalhealthtechnology3_xls.parse("HomePageLink")
    Revised1 = revised_structure_xls.parse("Sheet1")
    RevisedContext = revised_structure_xls.parse("context")
    RevisedGender = revised_structure_xls.parse("gender")
    RevisedAgeGroup = revised_structure_xls.parse("age_group")
    Revised_NBP = revised_structure_xls.parse("neutral behaviour prefix")
    Revised_DP = revised_structure_xls.parse("dimensional prefix")
    Revised_NBS = revised_structure_xls.parse("neutral behaviour suffix")


    # ------------------------------------------------------------------------------
    # Write header
    # with Ontologies listed in mentalhealth.Ontologies ------------------------------------------------------------------------------

    fid = open(outfile, 'w')
    header_string = write_header(
        base_uri,
        version,
        label,
        comment,
        prefixes=[
            (
                row[1]["Prefix"],
                row[1]["PrefixURI"]
            ) for row in Ontologies.iterrows()
        ]
    )
    fid.write(header_string)

if __name__ == "__main__":
    main()