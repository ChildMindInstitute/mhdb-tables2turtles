#!/usr/bin/env python
"""
This program converts five specific mental health spreadsheet workbooks to RDF
text documents.

Authors:
    - Arno Klein, 2017-2019 (arno@childmind.org)  http://binarybottle.com
    - Jon Clucas, 2017–2018 (jon.clucas@childmind.org)

Copyright 2019, Child Mind Institute MATTER Lab (https://matter.childmind.org),
Apache v2.0 License

"""
import os
import sys
mhdb_path = os.path.abspath(os.getcwd())
if mhdb_path not in sys.path:
    sys.path= [
        mhdb_path,
        *sys.path
    ]
try:
    from mhdb.info import __version__ as version
    from mhdb.spreadsheet_io import download_google_sheet
    from mhdb.ingest import *
    from mhdb.write_ttl import check_iri, turtle_from_dict, write_header
except:
    from mhdb.mhdb.info import __version__ as version
    from mhdb.spreadsheet_io import download_google_sheet
    from mhdb.mhdb.ingest import *
    from mhdb.mhdb.write_ttl import check_iri, turtle_from_dict, write_header
import numpy as np
import pandas as pd


def main():
    # ------------------------------------------------------------------------------
    # Try to get latest spreadsheets
    # Except use local copies
    # ------------------------------------------------------------------------------
    try:
        behaviorsFILE = download_google_sheet(
            'data/behaviors.xlsx',
            "1OHtVRqRXvCUuhyavcLSBU9YkiEJfThFKrXHmcg4627M"
        )
    except:
        behaviorsFILE = 'data/behaviors.xlsx'
    try:
        assessmentsFILE = download_google_sheet(
            'data/assessments.xlsx',
            "1VUf3XnieYThY8OA6JWtpNP4zI2xa9xak9LXuyH_PaoE"
        )
    except:
        assessmentsFILE = 'data/assessments.xlsx'
    try:
        technologiesFILE = download_google_sheet(
            'data/technologies.xlsx',
            "1LeLlrsvBWMYTTIXTVtkynmBzzb0Uzi1OwpRLfyRAwzM"
        )
    except:
        technologiesFILE = 'data/technologies.xlsx'
    try:
        dsm5FILE = download_google_sheet(
            'data/dsm5.xlsx',
            "13a0w3ouXq5sFCa0fBsg9xhWx67RGJJJqLjD_Oy1c3b0"
        )
    except:
        dsm5FILE = 'data/dsm5.xlsx'
    try:
        referencesFILE = download_google_sheet(
            'data/references.xlsx',
            "1KDZhoz9CgHBVclhoOKBgDegUA9Vczui5wj61sXMgh34"
        )
    except:
        referencesFILE = 'data/references.xlsx'

    base_uri = "http://www.purl.org/mentalhealth"
    dsm5_outfile = os.path.join(os.getcwd(), 'dsm5.ttl')
    assessments_outfile = os.path.join(os.getcwd(), 'assessments.ttl')
    technologies_outfile = os.path.join(os.getcwd(), 'technologies.ttl')
    behaviors_outfile = os.path.join(os.getcwd(), 'behaviors.ttl')
    references_outfile = os.path.join(os.getcwd(), 'references.ttl')

    # --------------------------------------------------------------------------
    # Import spreadsheets
    # --------------------------------------------------------------------------
    dsm5_xls = pd.ExcelFile(dsm5FILE)
    assessments_xls = pd.ExcelFile(assessmentsFILE)
    technologies_xls = pd.ExcelFile(technologiesFILE)
    behaviors_xls = pd.ExcelFile(behaviorsFILE)
    references_xls = pd.ExcelFile(referencesFILE)
    X = ['', 'nan', np.nan, 'None', None, []]

    # --------------------------------------------------------------------------
    # Create output RDF
    # --------------------------------------------------------------------------
    label = "mental health database"
    ddashes = "================================================================================"
    comment="""\n\n{0}\n\t\tMental Health Database\n{0}
This mental health database inter-relates information about mental health
symptoms, assessment questionnaires and tasks, etc., and is licensed
under the terms of the Creative Commons BY license.
Current information can be found on the website, http://mentalhealth.tech.

""".format(ddashes)

    do_dsm5 = True
    do_assessments = 0#True #False
    do_references = 0# True #False
    do_technologies = 0# True
    do_behaviors = 0# True #False

    if do_dsm5:
        dsm5_statements = ingest_dsm5(dsm5_xls, behaviors_xls, references_xls,
                                      technologies_xls, statements={})
        dsm5_turtle = turtle_from_dict(dsm5_statements)
    else:
        dsm5_statements = []
        dsm5_turtle = []
    if do_assessments:
        assessments_statements = ingest_assessments(assessments_xls,
            behaviors_xls, technologies_xls, references_xls, statements={})
        assessments_turtle = turtle_from_dict(assessments_statements)
    else:
        assessments_statements = []
        assessments_turtle = []

    if do_technologies:
        technologies_statements = ingest_technologies(technologies_xls, dsm5_xls,
            behaviors_xls, statements={})
        technologies_turtle = turtle_from_dict(technologies_statements)
    else:
        technologies_statements = []
        technologies_turtle = []

    if do_behaviors:
        behaviors_statements = ingest_behaviors(behaviors_xls, technologies_xls,
                                                dsm5_xls, statements={})
        behaviors_turtle = turtle_from_dict(behaviors_statements)
    else:
        behaviors_statements = []
        behaviors_turtle = []

    if do_references:
        references_statements = ingest_references(references_xls, behaviors_xls,
                                                  statements={})
        references_turtle = turtle_from_dict(references_statements)
    else:
        references_statements = []
        references_turtle = []

    # --------------------------------------------------------------------------
    # Write header and statements to turtle files
    # --------------------------------------------------------------------------
    outputs_list = [[dsm5_statements, dsm5_outfile, dsm5_turtle],
                    [assessments_statements, assessments_outfile, assessments_turtle],
                    [references_statements, references_outfile, references_turtle],
                    [technologies_statements, technologies_outfile, technologies_turtle],
                    [behaviors_statements, behaviors_outfile, behaviors_turtle]]

    for ioutput, output_list in enumerate(outputs_list):

        out_statements = output_list[0]
        out_file = output_list[1]
        out_turtle = output_list[2]

        if out_statements not in X:

            # Create header with ontologies
            import_prefixes = set()
            for subject in out_statements:
                if ":" in subject and \
                "://" not in subject and \
                not subject.startswith('"'):
                    import_prefixes.add(subject.split(":")[0])
                for predicate in out_statements[subject]:
                    if ":" in predicate and \
                    "://" not in predicate and \
                    not predicate.startswith('"'):
                        import_prefixes.add(predicate.split(":")[0])
                    for object in out_statements[subject][predicate]:
                        if ":" in object and \
                        "://" not in object and \
                        not object.startswith('"'):
                            import_prefixes.add(object.split(":")[0])
            prefixes = [(
                row[1]["Prefix"],
                row[1]["PrefixURI"],
                row[1]["ImportURI"]
            ) for row in references_xls.parse(
                'ontologies'
            ).iterrows() if row[1]["Prefix"] in import_prefixes]

            if ioutput == 0:
                header_string = write_header(
                    "{0}/{1}".format(base_uri, "dsm"),
                    version,
                    "{0} — {1}".format(label, "DSM-V supplement"),
                    "\n".join([
                        comment,
                        "{0}\n\t\tDSM-V supplement\n{0}\n\n".format(ddashes)
                    ]),
                    prefixes=prefixes
                )
            else:
                header_string = write_header(
                    base_uri,
                    version,
                    label,
                    comment,
                    prefixes=prefixes,
                    imports=True
                )

            fid = open(out_file, 'w')
            fid.write(header_string)
            fid.write("{0} .\n".format(out_turtle.rstrip(" .")))


if __name__ == "__main__":
    main()
